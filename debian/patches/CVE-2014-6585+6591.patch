Description: fix information disclosure via incorrect font file parsing
Origin: backport, http://bugs.icu-project.org/trac/changeset/37086
Bug: http://bugs.icu-project.org/trac/ticket/11525
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776264

Index: icu-4.4.1/source/layout/CursiveAttachmentSubtables.cpp
===================================================================
--- icu-4.4.1.orig/source/layout/CursiveAttachmentSubtables.cpp
+++ icu-4.4.1/source/layout/CursiveAttachmentSubtables.cpp
@@ -20,7 +20,10 @@ le_uint32 CursiveAttachmentSubtable::pro
     le_int32  coverageIndex = getGlyphCoverage(base, glyphID, success);
     le_uint16 eeCount       = SWAPW(entryExitCount);
 
-    if (coverageIndex < 0 || coverageIndex >= eeCount) {
+    LEReferenceToArrayOf<EntryExitRecord>
+        entryExitRecordsArrayRef(base, success, entryExitRecords, coverageIndex);
+
+    if (coverageIndex < 0 || coverageIndex >= eeCount || LE_FAILURE(success)) {
         glyphIterator->setCursiveGlyph();
         return 0;
     }
Index: icu-4.4.1/source/layout/Features.cpp
===================================================================
--- icu-4.4.1.orig/source/layout/Features.cpp
+++ icu-4.4.1/source/layout/Features.cpp
@@ -15,6 +15,9 @@ U_NAMESPACE_BEGIN
 
 LEReferenceTo<FeatureTable> FeatureListTable::getFeatureTable(const LETableReference &base, le_uint16 featureIndex, LETag *featureTag, LEErrorCode &success) const
 {
+    LEReferenceToArrayOf<FeatureRecord>
+        featureRecordArrayRef(base, success, featureRecordArray, featureIndex);
+
   if (featureIndex >= SWAPW(featureCount) || LE_FAILURE(success)) {
     return LEReferenceTo<FeatureTable>();
   }
Index: icu-4.4.1/source/layout/LETableReference.h
===================================================================
--- icu-4.4.1.orig/source/layout/LETableReference.h
+++ icu-4.4.1/source/layout/LETableReference.h
@@ -313,7 +313,12 @@ LE_TRACE_TR("INFO: new RTAO")
   const T *getAliasRAW() const { LE_DEBUG_TR("getAliasRAW<>"); return (const T*)fStart; }
 
   const T& getObject(le_uint32 i, LEErrorCode &success) const {
-    return *getAlias(i,success);
+      const T *ret = getAlias(i, success);
+      if (LE_FAILURE(success) || ret==NULL) {
+          return *(new T(0));
+      } else {
+          return *ret;
+     }
   }
   
   const T& operator()(le_uint32 i, LEErrorCode &success) const {
Index: icu-4.4.1/source/layout/LigatureSubstSubtables.cpp
===================================================================
--- icu-4.4.1.orig/source/layout/LigatureSubstSubtables.cpp
+++ icu-4.4.1/source/layout/LigatureSubstSubtables.cpp
@@ -27,6 +27,9 @@ le_uint32 LigatureSubstitutionSubtable::
             Offset ligTableOffset = SWAPW(ligSetTable->ligatureTableOffsetArray[lig]);
             const LigatureTable *ligTable = (const LigatureTable *) ((char *)ligSetTable + ligTableOffset);
             le_uint16 compCount = SWAPW(ligTable->compCount) - 1;
+            LEReferenceToArrayOf<TTGlyphID>
+                componentArrayRef(base, success, ligTable->componentArray, compCount);
+            if (LE_FAILURE(success)) { return 0; }
             le_int32 startPosition = glyphIterator->getCurrStreamPosition();
             TTGlyphID ligGlyph = SWAPW(ligTable->ligGlyph);
             le_uint16 comp;
Index: icu-4.4.1/source/layout/MultipleSubstSubtables.cpp
===================================================================
--- icu-4.4.1.orig/source/layout/MultipleSubstSubtables.cpp
+++ icu-4.4.1/source/layout/MultipleSubstSubtables.cpp
@@ -35,7 +35,12 @@ le_uint32 MultipleSubstitutionSubtable::
 
     le_int32 coverageIndex = getGlyphCoverage(base, glyph, success);
     le_uint16 seqCount = SWAPW(sequenceCount);
+    LEReferenceToArrayOf<Offset>
+        sequenceTableOffsetArrayRef(base, success, sequenceTableOffsetArray, seqCount);
 
+    if (LE_FAILURE(success)) {
+        return 0;
+    }
     if (coverageIndex >= 0 && coverageIndex < seqCount) {
         Offset sequenceTableOffset = SWAPW(sequenceTableOffsetArray[coverageIndex]);
         const SequenceTable *sequenceTable = (const SequenceTable *) ((char *) this + sequenceTableOffset);
